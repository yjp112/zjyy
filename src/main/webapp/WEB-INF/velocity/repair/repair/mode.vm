#parse("index/_header.vm")
</head>
<body>
<div class="ui-layout-center" id="subMain">
	<div class="ui-layout-north">
		 <form class="ui-form" id='queryForm'>
	     <table width="100%">
	       <tr>
	         <td>
	           <table class="ui-search-table">
	             <tr>
	               <td class="ui-search-name first" style="width: 100px;">统计时间：</td>
                   <td class="ui-search-c" >
					 <input id="startTime"  class="k-textbox" type="text" name="startTime" value=""/>
					 <span class="ui-form-text">至</span> 
					 <input class="k-textbox" id="endTime" type="text" name="endTime" value=""/>
                   </td>
	             </tr>
	           </table>
	         </td>
	         <td width="150" valign="top" style="padding-top:4px;">
	           <button type="submit" class="hc_btn k-primary" id="queryBtn"><i class="fa fa-search"></i>查询</button>
	           <button type="reset" class="hc_btn" id="resetBtn"><i class="fa fa-refresh"></i>重置</button>
	         </td>
	         <td></td>
	       </tr>
	     </table>
	 	</form>
	</div>
	<div class="ui-layout-center">
	  <div id="grid" style="display:none;"></div> 
	  <div id="mode_id" style="height:300px"></div> 
     </div>
</div>
#parse("index/_footer.vm")  
<script src="$!{main_static_custom_url}/js/echarts/echarts.js"></script>
<script type="text/javascript">
var myRateChart = null;
     var _iframe_layout,_inner_layout;
	$(document).ready(function(){
		_iframe_layout = $('body').layout({
		      defaults: {
		        resizable: false,
		        closable: false,
		        spacing_open: 5
		      }
		    });
		 _inner_layout = $("#subMain").layout({
		      defaults: {
		        resizable: false,
		        closable: false,
		        spacing_open: 0
		      },
		      center: {
		          onresize_end: function () {
##		              var grid = $("#grid").data("kendoGrid");
##		              grid.resize();
		          }
		      }
     })
	//列表
	quick_datagrid("#grid", "#queryForm", "$!{rc.contextPath}/repair/repair/mode", [
	      {
	          field: "id",
	          hidden: true
	      }
		  ], 
	  {
	      sortable: {
	          mode: "multiple",
	          allowUnsort: true
	      },
	      pageable:false, 
	      showNumber:false,
	      resizable:true
	      
	  },{
		  change:generateRateChart
	  }, {
	      serverSorting: true
	  });
	  
	  $('#resetBtn').click(function(){
		clearDateWithout("startTime", "endTime");
		$("#queryForm :text").val('');  
    });
//加载时间控件
 commonMonthWithout("startTime", "endTime", "yyyy-MM", "zh-CN");
});
//加载chart
function loadEchart(option){
        require.config({
            packages: [
                {
                    name: 'echarts',
                    location: '$!{main_static_custom_url}/js/echarts',
                    main: 'echarts'
                }
            ]
        });
        require(
                [
                    'echarts',
                    'echarts/chart/bar'
                ],
                function(ec) {
                    myRateChart = ec.init(document.getElementById('mode_id'));
                    myRateChart.setOption(option);
                }
        )
    }
function generateRateChart(grid,g) {
	var datas1 = new Array();
	var datas2 = new Array();
    var shortcut = new Array();
    var data = grid.items;
    var startTime=$("#startTime").val();
    var endTime=$("#endTime").val();
    var now=new Date();
    if(endTime!=""){
		now=new Date(endTime);    	
    }
    var startMonth=0;
    if(startTime!=""){
    	startMonth=new Date(startTime).getMonth();
    }
    var month=now.getMonth();
    var j=0;
    var v=0;
    for(var i=startMonth;i<=month;i++){
    	j=0;
    	v=0;
    	var imonth=new Date(now.getFullYear(),i).format('yyyy-MM');
    	 $.each(data,function(index,o){	
	    	var repairMonth=new Date(o.repairMonth).format('yyyy-MM');
	    	if(repairMonth!=null && repairMonth!=''){
	    		if(repairMonth!=imonth){
	    			j++;
	    			v++;
	    		}else{
	    			if(o.repairMode=='0'){
	    				datas1.push(o.sumMode);
	    				v++;
	    			}else{
	    				datas2.push(o.sumMode);
	    				j++;
	    			}
	    		}
	    		if(j==data.length){
	    				datas1.push(0);
	    		}
	    		if(v==data.length){
	    				datas2.push(0);
	    		}
		    }
	      });
	      
	      shortcut.push(imonth)
    }
    option = {
		title : {
            text: '外委自修统计',
            x:'center'
        },
        tooltip : {
	        trigger: 'axis',
	        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
	            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
	        },
	        formatter: function (param){
	            return param[0][1] + '<br/>'
	                   + param[0][0] + ' : ' + param[0][2] + '<br/>'
	                   + param[1][0] + ' : ' + (param[1][2]);
	        }
	    },
	    legend: {
	        selectedMode:false,
	        x : 'right',
        	y : 'top',
	        data:['委外', '自修']
	    },
	
	    //calculable : true,
	    xAxis : [
	        {
	            type : 'category',
	            data : shortcut
	        }
	    ],
	    yAxis : [
	        {
	            type : 'value',
	            boundaryGap: [0, 0.1]
	        }
	    ],
	    series : [
	        {
	            name:'委外',
	            type:'bar',
	            stack: 'sum',
	            barCategoryGap: '50%',
	            itemStyle: {
	                normal: {
	                    color: '#FF6347',
	                    borderColor: '#FF6347',
	                    borderWidth: 6,
	                    borderRadius:0,
	                    label : {
	                        show: true, position: 'insideTop'
	                    }
	                }
	            },
	            data:datas1
	        },
	        {
	            name:'自修',
	            type:'bar',
	            stack: 'sum',
	            itemStyle: {
	                normal: {
	                    color: '#fff',
	                    borderColor: '#FF6347',
	                    borderWidth: 6,
	                    borderRadius:0,
	                    label : {
	                        show: true, 
	                        position: 'top',
	                        formatter: function (a, b, c) {
	                            for (var i = 0, l = option.xAxis[0].data.length; i < l; i++) {
	                                if (option.xAxis[0].data[i] == b) {
	                                    return option.series[0].data[i] + c;
	                                }
	                            }
	                        },
	                        textStyle: {
	                            color: '#FF6347'
	                        }
	                    }
	                }
	            },
	            data:datas2
	        }
	    ]		
	};
 	if(myRateChart==null){
        loadEchart(option);
    }else{
        if(data.length!=0){
			loadEchart(option);
            myRateChart.setOption(option);
        }else{
            myRateChart.clear();
			myRateChart.setOption(option);
        }
    }
}    
</script>
</body>
</html>