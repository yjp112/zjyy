#parse("index/_header.vm")
</head>
<body>
<div id="tabstrip" class="k-header k-grid-toolbar" style="padding-left:10px;">
    <ul>
        <li class="k-state-active">用电量</li>
        <li>启停记录</li>
    </ul>
    <div id="tabstrip-1">
        <div class="ui-layout-north">
            <form class="ui-form " id='queryForm'>
                <input type="hidden" name="deviceId" value="$!{deviceId}">
                <table width="90%">
                    <tr>
                        <td >
                            <table class="ui-search-table" >
                                <tr>
                                    <td class="ui-search-name first" style="width: 100px;">统计时间：</td>
                                    <td class="ui-search-c" >
                                        <input  id="startDate"  class="k-textbox"  name="startTime" value="$!{startTime}"/>
                                        至
                                        <input id="endDate"  class="k-textbox"  name="endTime" value="$!{endTime}"/>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td width="150" valign="top" style="padding-top:4px;">
                            <button type="submit" class="hc_btn k-primary" id="queryBtn" style="color: #fff;"><i class="fa fa-search"></i>查询</button>
                        </td>
                        <td></td>
                    </tr>
                </table>
            </form>
        </div>
        <div class="ui-layout-center" id="subMain">

            <div class="ui-layout-north">
                <div id="graphic_rate_id" style="height:350px">
                </div>
            </div>
            <div class="ui-layout-center">
                <div id="grid" style="display:none;"></div>
            </div>
        </div>

    </div>
    <div id="tabstrip-2">
        <div id="grid10"></div>
    </div>
</div>

#parse("index/_footer.vm")  
<script src="$!rc.contextPath/main_static/custom/js/echarts/echarts.js"></script>

<script type="text/javascript">

var myRateChart = null;
var flag = 0;

var _iframe_layout, _left_layout, _inner_layout;
$(document).ready(function(){
	/*_iframe_layout = $('body').layout({
	  defaults: {
	    resizable: false,
	    closable: false,
	    spacing_open: 5
	  },
	  north: {
	    size: 0.1
	  }
	});

	_inner_layout = $("#subMain").layout({
	    defaults: {
	      resizable: false,
	      closable: false,
	      spacing_open: 0
	    },
	    north:{
	    	size: 400
	    },
	    center: {
	        onresize_end: function () {
	            var grid = $("#grid").data("kendoGrid");
	            grid.resize();
	        }
	    }
    });*/

    $("#tabstrip").hcTabStrip();
  
commonDateWithout("startDate","endDate","yyyy-MM-dd","zh-CN"); 
  
//列表
quick_datagrid("#grid", "#queryForm", "$!rc.contextPath/dev/gis/vrv/list?r=" + new Date(), [{
          field: "id",
          hidden: true
      }
	  ], 
  {
      sortable: {
          mode: "multiple",
          allowUnsort: true
      },
      pageable:false, 
      showNumber:false,resizable:true
      
  },{
	  change:generateRateChart
  }, {
      serverSorting: true
  });
  

//启停记录
quick_datagrid("#grid10", "#queryForm10", "$!{rc.contextPath}/device/device/findstartStopRecords?deviceId=$!{id}", [
    {
        field: "id",
        hidden: true
    },
    {
        field: "startTime",
        title: "开启时间",
        sortable: false,
        headerAttributes: {"class": "k-grid-equilong"},
        attributes: {"class": "k-grid-equilong"}

    },
    {
        field: "stopTime",
        title: "关闭时间",
        sortable: false,
        headerAttributes: {"class": "k-grid-equilong"},
        attributes: {"class": "k-grid-equilong"}
    },
    {
        field: "runTimes",
        sortable: false,
        title: "运行时间(小时)",
        template: function (dataItem) {
            if (dataItem.runTimes != null)
                return fInt(dataItem.runTimes);
            else return '';
        },
        headerAttributes: {"class": "k-grid-equilong"},
        attributes: {"class": "k-grid-equilong"}
    }

], {
    height: 393,
    pageSize: 10
});
//----------------------end---------------


//加载chart
function loadEchart(option){
        require.config({
            packages: [
                {
                    name: 'echarts',
                    location: '$!rc.contextPath/main_static/custom/js/echarts',
                    main: 'echarts'
                }
            ]
        });
        require(
                [
                    'echarts',
                    'echarts/chart/line',
                    'echarts/chart/bar'
                ],
                function(ec) {
                	
                    myRateChart = ec.init(document.getElementById('graphic_rate_id'));
                    myRateChart.setOption(option);
                }
        )
    }

    function generateRateChart(grid,g) {

        var visitMonth = new Array();
        var visitorNum = new Array();

        var data = grid.items;
        $.each(data,function(index,o){
            visitorNum.push(o.electricValue);
            visitMonth.push(o.days);
        });

        option = {
            title : {
                text: '$!{deviceName}'+'用电量',
				x: 'center'
            },
            tooltip : {
                trigger: 'axis'
            },
            legend: {
                data:['用电量'],
				x: '1000px'
            },
            grid: {
                x2: 120,
            },
            calculable : true,
            xAxis : [
                {
                    type : 'category',
                    boundaryGap : false,
                    data : visitMonth
                }
            ],
            yAxis : [
                {
                    type : 'value',
                    axisLabel : {
                        formatter: '{value} 度'
                    }
                }
            ],
            series : [
                {
                    name:'用电量',
                    type:'line',
                    data:visitorNum,
                    markPoint : {
                        data : [
                            {type : 'max', name: '最大值'}
                        ]
                    },
                    markLine : {
                        data : [
                            {type : 'average', name: '平均值'}
                        ]
                    }
                }
            ]
        };
                    

        
        if(myRateChart==null){
            if(data.length!=0)
            	loadEchart(option);//datagrid查询结果为空
        }else{
            if(data.length!=0){
				myRateChart.clear();
                myRateChart.setOption(option);
            }else{
                myRateChart.clear();
            }
        }
    }
});	
</script>
</body>
</html>